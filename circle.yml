machine:
  services:
    # we want to test on the same database as production
    #- mysql # We are using sqlite in memory right now
    - docker
  environment:
    # created this api at: https://circleci.com/gh/vikingco/mvne-platform/edit#api using type "all"
    derp: herp

dependencies:
  cache_directories:
    - buildcache
    - docker_cache
  pre:
    - mkdir -p docker_cache
    - docker version && docker info
    - |
        if [[ ! -e buildcache/buildcache ]]; then
          mkdir buildcache
          wget -O buildcache/buildcache https://s3-eu-west-1.amazonaws.com/mobiliferoot/buildcache
        fi
    - sudo install -m 0775 buildcache/buildcache /usr/bin
  override:
    - |
      if [[ -e docker_cache/cache.tar ]]; then
        echo "Loading the image cache (docker cache)"
        docker load -i docker_cache/cache.tar
      fi
    - echo "test build cache"
    - buildcache
    - docker build -t vikingco/docker-buildcache:latest .
    - docker save -o docker_cache/cache.tar    vikingco/docker-buildcache:latest
  post:
    - echo 'done'

test:
  override:
    - echo 'override test'
  post:
    - echo 'post test'

deployment:
  default:
    branch: /.*/
    commands:
      - echo 'deploy'
