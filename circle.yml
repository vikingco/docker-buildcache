machine:
  environment:
    IMAGE_TAG: build-with-cache-${CIRCLE_BUILD_NUM}-$(cd $CIRCLE_PROJECT_REPONAME && git rev-parse --short HEAD)
    IMAGE_REPO: "enermis/build-image"

  pre:
    - echo 'no_cache() { git log --format=%B -n 1 | grep -q "no cache"; }' >> ~/.circlerc
    - echo 'docker-push-with-retry() { for i in 1 2 3; do docker push $1; if [ $? -eq 0 ]; then return 0; fi; echo "Retrying...."; done; return 1; }' >> ~/.circlerc
    - git clone git@github.com:kimh/docker-cache-shim.git && cd docker-cache-shim && sudo ./install.sh

  post:
    - sudo curl -L -o /usr/bin/docker 'https://s3.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo service docker start

dependencies:
  cache_directories:
    - "~/docker"

  override:
    - echo "Building Docker image $IMAGE_REPO:$IMAGE_TAG"
    - docker login -e fulgens.ailurus@gmail.com -u enermis -p supersecret

    - docker-cache-shim pull ${IMAGE_REPO}:
        timeout: 3600

    - ? |
        if $(no_cache); then
          docker build --no-cache --build-arg IMAGE_TAG=${IMAGE_TAG} -t ${IMAGE_REPO}:${IMAGE_TAG} .;
        else
          docker build --build-arg IMAGE_TAG=${IMAGE_TAG} -t ${IMAGE_REPO}:${IMAGE_TAG} .;
        fi
      :
        timeout: 3600

    - docker-cache-shim push ${IMAGE_REPO}:${IMAGE_TAG}:
        timeout: 3600

    - docker-push-with-retry ${IMAGE_REPO}:${IMAGE_TAG}

    # Build a slightly modified image for unprivileged lxc
    - docker build --build-arg TARGET_UNPRIVILEGED_LXC=true --build-arg IMAGE_TAG=${IMAGE_TAG} -t ${IMAGE_REPO}:${IMAGE_TAG}-unprivileged .:
        timeout: 3600

    - docker-push-with-retry ${IMAGE_REPO}:${IMAGE_TAG}-unprivileged:
        timeout: 3600

    - docker-push-with-retry ${IMAGE_REPO}:${IMAGE_TAG}-unprivileged:
        timeout: 3600

    - docker --version
    - docker info
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar && echo 'docker load'; fi
    - docker build -t vikingco/docker-buildcache:latest .
    - mkdir -p ~/docker; docker save vikingco/docker-buildcache:latest > ~/docker/image.tar

deployment:
  default:
    branch: /.*/
    commands:
      - echo 'deploy'

test:
  override:
      - echo 'override test'
